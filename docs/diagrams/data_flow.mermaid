sequenceDiagram
    participant U as User
    participant F as Frontend
    participant B as Backend
    participant R as RAG Service
    participant L as Logging Service
    participant LLM as vLLM Service
    participant C as ChromaDB
    
    Note over U,C: Complete Chat Flow with RAG
    
    %% Session Creation
    U->>F: Open chat interface
    F->>B: POST /sessions
    B-->>F: session_id
    F-->>U: Chat interface ready
    
    %% Chat Request Flow
    U->>F: Send message: "¿Qué es OOP?"
    F->>B: POST /chat {message, subject, session_id}
    
    Note over B: Validate & Rate Limit
    B->>B: Validate request
    B->>B: Check rate limits
    
    %% RAG Search
    B->>R: POST /search {query, subject, k=5}
    R->>C: Search similar documents
    C-->>R: Retrieved documents + scores
    R-->>B: {documents, sources, relevance}
    
    %% LLM Generation
    B->>LLM: POST /generate {context + query}
    Note over LLM: Generate response with context
    LLM-->>B: Generated response
    
    %% Logging
    par Log Interaction
        B->>L: POST /log/interaction {user_id, query, response, sources}
        L->>L: Store interaction data
        L-->>B: Logged successfully
    and Update Session
        B->>B: Update session metadata
        B->>B: Increment message count
    end
    
    %% Response
    B-->>F: {response, sources, timestamp, processing_time}
    F-->>U: Display response with sources
    
    Note over U,C: Response includes sources and took ~2-5 seconds
